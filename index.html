<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,viewport-fit=cover">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="description" content="MagicMist">
    <link rel="icon" type="image/x-icon" href="favicon.ico">
    <link rel="apple-touch-icon" href="Mist.png">
    <title>MagicMist</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
            -webkit-user-select: none;
            user-select: none;
        }

        html {
            width: 100vw;
            height: 100vh;
            overflow: hidden;
            background: #000000;
        }

        body {
            width: 100%;
            height: 100%;
            overflow: hidden;
            font-family: "PingFang SC", -apple-system, BlinkMacSystemFont, sans-serif;
            background-color: #000000;
            color: #FFFFFF;
            font-weight: 700;
            position: relative;
            touch-action: none;
            margin: 0;
            padding: 0;
        }

        /* 认证界面 */
        #auth-container {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: #000000;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            align-items: center;
            padding-top: env(safe-area-inset-top);
            padding-bottom: env(safe-area-inset-bottom);
            z-index: 100;
            overflow: hidden;
            transition: opacity 0.3s ease;
        }

        .auth-image-container {
            flex: 1;
            display: flex;
            justify-content: center;
            align-items: center;
            width: 100%;
        }

        .auth-image {
            width: 220px;
            height: 220px;
            background: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="200" height="200" viewBox="0 0 200 200"><rect width="200" height="200" fill="%23333" rx="20"/><text x="50%" y="50%" dominant-baseline="middle" text-anchor="middle" fill="white" font-family="Arial" font-size="24">Mist.png</text></svg>') center/contain no-repeat;
            position: relative;
            border-radius: 20px;
            overflow: hidden;
            box-shadow: 0 4px 12px rgba(255, 255, 255, 0.1);
            transition: transform 0.3s ease;
        }

        .auth-image:active {
            transform: scale(0.98);
        }

        .auth-button-container {
            width: 100%;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }

        .auth-button {
            background: #FFFFFF;
            color: #000000;
            border: none;
            border-radius: 30px;
            padding: 16px 40px;
            font-size: 18px;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.3s ease;
            font-family: "PingFang SC", -apple-system, BlinkMacSystemFont, sans-serif;
            position: relative;
            overflow: hidden;
        }

        .auth-button:active {
            transform: scale(0.95);
            opacity: 0.8;
        }

        .auth-button:disabled {
            opacity: 0.7;
            cursor: not-allowed;
        }

        .auth-button-loading .auth-button-text {
            opacity: 0;
        }

        .auth-button-loading::after {
            content: "";
            position: absolute;
            width: 20px;
            height: 20px;
            top: 50%;
            left: 50%;
            margin-left: -10px;
            margin-top: -10px;
            border: 2px solid #000000;
            border-radius: 50%;
            border-top-color: transparent;
            animation: spin 1s ease infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .auth-status {
            margin-top: 15px;
            color: rgba(255, 255, 255, 0.7);
            font-size: 14px;
            min-height: 20px;
            text-align: center;
            font-weight: 700;
            transition: color 0.3s ease;
        }

        /* 主内容区域 */
        #content-container {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            background: #000000;
            z-index: 50;
            opacity: 0;
            transition: opacity 0.3s ease;
            overflow: hidden;
            /* 扩展覆盖安全区域 */
            top: calc(-1 * env(safe-area-inset-top, 0px));
            left: calc(-1 * env(safe-area-inset-left, 0px));
            width: calc(100% + env(safe-area-inset-left, 0px) + env(safe-area-inset-right, 0px));
            height: calc(100% + env(safe-area-inset-top, 0px) + env(safe-area-inset-bottom, 0px));
        }

        #content-container.active {
            opacity: 1;
            display: block;
        }

        /* 主内容区域布局 */
        .main-content {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 90%;
            max-width: 900px;
            min-height: 600px;
            text-align: center;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 60px 40px;
            border-radius: 30px;
            overflow: hidden;
            background-color: rgba(0, 0, 0, 0.4);
            /* 添加新的背景样式 */
            background-image: 
                radial-gradient(circle at 25% 25%, rgba(120, 119, 198, 0.3) 0%, transparent 50%),
                radial-gradient(circle at 75% 75%, rgba(255, 119, 198, 0.3) 0%, transparent 50%);
        }

        /* 新的模糊背景实现 - 使用CSS渐变和模糊效果 */
        .main-content::before {
            content: '';
            position: absolute;
            top: -10px;
            left: -10px;
            right: -10px;
            bottom: -10px;
            background: 
                linear-gradient(45deg, rgba(30, 30, 60, 0.9) 0%, rgba(10, 10, 20, 0.9) 100%),
                url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="100" height="100" viewBox="0 0 100 100"><rect width="100" height="100" fill="%23222" rx="10"/><circle cx="50" cy="50" r="40" fill="%23333"/><circle cx="50" cy="50" r="30" fill="%23444"/><circle cx="50" cy="50" r="20" fill="%23555"/><circle cx="50" cy="50" r="10" fill="%23666"/></svg>');
            background-size: cover, 200px;
            background-position: center;
            background-repeat: no-repeat;
            filter: blur(8px) brightness(0.7);
            border-radius: 35px;
            z-index: -1;
        }

        /* 备用背景 - 如果图片加载失败 */
        .main-content::after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: 
                radial-gradient(circle at 20% 80%, rgba(120, 119, 198, 0.15) 0%, transparent 50%),
                radial-gradient(circle at 80% 20%, rgba(255, 119, 198, 0.15) 0%, transparent 50%),
                radial-gradient(circle at 40% 40%, rgba(120, 198, 255, 0.1) 0%, transparent 50%);
            border-radius: 30px;
            z-index: -1;
        }

        /* 主内容图片 */
        .content-image {
            width: 280px;
            height: 280px;
            background: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="280" height="280" viewBox="0 0 280 280"><rect width="280" height="280" fill="%23333" rx="25"/><text x="50%" y="50%" dominant-baseline="middle" text-anchor="middle" fill="white" font-family="Arial" font-size="32">Mist.png</text></svg>') center/contain no-repeat;
            margin-bottom: 40px;
            border-radius: 25px;
            box-shadow: 0 8px 25px rgba(255, 255, 255, 0.1);
            position: relative;
            z-index: 1;
        }

        /* 文本轮换区域 */
        .text-rotator {
            width: 100%;
            text-align: center;
            color: #FFFFFF;
            font-size: 52px;
            font-weight: 700;
            font-family: "Hiragino Maru Gothic ProN", "Hiragino Kaku Gothic ProN", "Hiragino Sans", "Yu Gothic", "Meiryo", sans-serif;
            height: 90px;
            overflow: hidden;
            position: relative;
            background-color: rgba(0, 0, 0, 0.6);
            border-radius: 15px;
            padding: 15px 20px;
            z-index: 1;
            margin-top: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .rotating-text {
            position: absolute;
            width: 100%;
            opacity: 0;
            transform: translateY(20px);
            transition: all 0.4s ease;
            font-weight: 700;
            font-family: inherit;
            color: #FFFFFF;
            text-align: center;
            line-height: 1.2;
        }

        .rotating-text.active {
            opacity: 1;
            transform: translateY(0);
        }

        .rotating-text.exiting {
            opacity: 0;
            transform: translateY(-20px);
        }

        /* 响应式设计 */
        @media (max-width: 768px) {
            .auth-image {
                width: 180px;
                height: 180px;
                border-radius: 16px;
            }
            
            .content-image {
                width: 220px;
                height: 220px;
                margin-bottom: 30px;
            }
            
            .text-rotator {
                font-size: 44px;
                height: 80px;
                padding: 12px 16px;
            }
            
            .main-content {
                padding: 50px 30px;
                border-radius: 25px;
                min-height: 550px;
            }
            
            .main-content::before {
                border-radius: 30px;
            }
        }

        @media (max-width: 480px) {
            .auth-button {
                padding: 14px 32px;
                font-size: 16px;
            }
            
            .auth-image {
                width: 150px;
                height: 150px;
                border-radius: 14px;
            }
            
            .content-image {
                width: 180px;
                height: 180px;
                margin-bottom: 25px;
                border-radius: 20px;
            }
            
            .text-rotator {
                font-size: 36px;
                height: 70px;
                padding: 10px 14px;
            }
            
            .main-content {
                padding: 40px 20px;
                border-radius: 20px;
                min-height: 500px;
            }
            
            .main-content::before {
                border-radius: 25px;
            }
        }
        
        /* 防止滚动 */
        .no-scroll {
            overflow: hidden;
        }

        /* 为不支持env()的浏览器提供回退 */
        @supports not (top: env(safe-area-inset-top)) {
            #content-container {
                top: calc(-1 * constant(safe-area-inset-top, 0px));
                left: calc(-1 * constant(safe-area-inset-left, 0px));
                width: calc(100% + constant(safe-area-inset-left, 0px) + constant(safe-area-inset-right, 0px));
                height: calc(100% + constant(safe-area-inset-top, 0px) + constant(safe-area-inset-bottom, 0px));
            }
        }
    </style>
</head>
<body class="no-scroll">
    <!-- Face ID认证界面 -->
    <div id="auth-container">
        <div class="auth-image-container">
            <div class="auth-image" role="img" aria-label="MagicMist应用图标"></div>
        </div>
        <div class="auth-button-container">
            <button class="auth-button" id="authButton" aria-describedby="authStatus">
                <span class="auth-button-text">Face ID认证</span>
            </button>
            <div class="auth-status" id="authStatus" aria-live="polite"></div>
        </div>
    </div>

    <!-- 主内容区域 -->
    <div id="content-container">
        <div class="main-content">
            <div class="content-image" role="img" aria-label="MagicMist应用图标"></div>
            <div class="text-rotator" id="textRotator">
                <!-- 文本将通过JavaScript动态添加 -->
            </div>
        </div>
    </div>

    <script>
        // 应用配置
        const CONFIG = {
            // WebAuthn配置
            webauthn: {
                rpName: "MagicMist",
                userName: "霧@MagicMist",
                userDisplayName: "霧@MagicMist'",
                timeout: 60000
            },
            
            // 文本轮换配置
            textRotation: {
                texts: [
                    "霧",
                    "雾", 
                    "Mist",
                    "Tipcy"
                ],
                interval: 1200,
                transitionDuration: 400
            }
        };
        
        // 应用状态管理
        const AppState = {
            isAuthenticated: false,
            credentialId: null
        };
        
        // DOM元素引用
        const DOM = {
            authContainer: document.getElementById('auth-container'),
            contentContainer: document.getElementById('content-container'),
            authButton: document.getElementById('authButton'),
            authButtonText: document.querySelector('.auth-button-text'),
            authStatus: document.getElementById('authStatus'),
            textRotator: document.getElementById('textRotator')
        };
        
        // 文本轮换管理器
        const TextRotator = {
            currentIndex: 0,
            intervalId: null,
            
            // 初始化文本轮换
            init: function() {
                // 创建文本元素
                this.createTextElements();
                
                // 显示第一个文本
                this.showText(0);
                
                // 开始轮换
                this.startRotation();
            },
            
            // 创建文本元素
            createTextElements: function() {
                DOM.textRotator.innerHTML = '';
                
                CONFIG.textRotation.texts.forEach((text, index) => {
                    const textElement = document.createElement('div');
                    textElement.className = 'rotating-text';
                    textElement.textContent = text;
                    textElement.dataset.index = index;
                    DOM.textRotator.appendChild(textElement);
                });
            },
            
            // 显示指定索引的文本
            showText: function(index) {
                const texts = document.querySelectorAll('.rotating-text');
                
                // 移除所有活动类
                texts.forEach(text => {
                    text.classList.remove('active', 'exiting');
                });
                
                // 设置新文本为活动状态
                if (texts[index]) {
                    texts[index].classList.add('active');
                }
                
                this.currentIndex = index;
            },
            
            // 切换到下一个文本
            nextText: function() {
                const texts = document.querySelectorAll('.rotating-text');
                const currentText = texts[this.currentIndex];
                
                // 添加退出动画类
                if (currentText) {
                    currentText.classList.add('exiting');
                }
                
                // 计算下一个索引
                const nextIndex = (this.currentIndex + 1) % texts.length;
                
                // 延迟显示新文本，确保过渡效果可见
                setTimeout(() => {
                    this.showText(nextIndex);
                }, CONFIG.textRotation.transitionDuration);
            },
            
            // 开始轮换
            startRotation: function() {
                this.intervalId = setInterval(() => {
                    this.nextText();
                }, CONFIG.textRotation.interval);
            },
            
            // 停止轮换
            stopRotation: function() {
                if (this.intervalId) {
                    clearInterval(this.intervalId);
                    this.intervalId = null;
                }
            },
            
            // 重置轮换
            reset: function() {
                this.stopRotation();
                this.currentIndex = 0;
                this.showText(0);
                this.startRotation();
            }
        };
        
        // 认证管理器
        const AuthManager = {
            // 初始化认证
            init: function() {
                // 检查是否支持WebAuthn
                if (!window.PublicKeyCredential) {
                    this.showError("您的设备不支持生物识别功能");
                    DOM.authButton.disabled = true;
                    return;
                }
                
                // 检查是否有已保存的通行密钥
                this.checkExistingCredentials();
                
                // 添加认证按钮事件监听
                DOM.authButton.addEventListener('click', () => this.startAuthentication());
                
                // 防止滚动
                this.preventScroll();
            },
            
            // 防止页面滚动
            preventScroll: function() {
                document.body.addEventListener('touchmove', function(e) {
                    e.preventDefault();
                }, { passive: false });
                
                document.addEventListener('scroll', function(e) {
                    e.preventDefault();
                    window.scrollTo(0, 0);
                });
            },
            
            // 检查已有凭证
            checkExistingCredentials: function() {
                try {
                    const savedCredentialId = localStorage.getItem('webauthn_credential_id');
                    
                    if (savedCredentialId) {
                        AppState.credentialId = Uint8Array.from(savedCredentialId.split(',').map(Number));
                        DOM.authButtonText.textContent = "使用Face ID登录";
                    } else {
                        DOM.authButtonText.textContent = "注册Face ID";
                    }
                } catch (error) {
                    console.error("检查已保存凭证时出错:", error);
                    DOM.authButtonText.textContent = "Face ID认证";
                }
            },
            
            // 开始认证流程
            startAuthentication: async function() {
                try {
                    DOM.authButton.disabled = true;
                    DOM.authButton.classList.add('auth-button-loading');
                    this.updateStatus("准备认证中...");
                    
                    if (AppState.credentialId) {
                        this.updateStatus("请使用Face ID进行认证...");
                        await this.authenticateWithCredential();
                    } else {
                        this.updateStatus("正在注册Face ID...");
                        await this.registerNewCredential();
                    }
                } catch (error) {
                    console.error("认证失败:", error);
                    this.showError("认证失败: " + error.message);
                    DOM.authButton.disabled = false;
                    DOM.authButton.classList.remove('auth-button-loading');
                }
            },
            
            // 注册新凭证
            registerNewCredential: async function() {
                const challenge = new Uint8Array(32);
                crypto.getRandomValues(challenge);
                
                const publicKey = {
                    challenge: challenge,
                    rp: { 
                        id: window.location.hostname, 
                        name: CONFIG.webauthn.rpName
                    },
                    user: {
                        id: new Uint8Array(16),
                        name: CONFIG.webauthn.userName,
                        displayName: CONFIG.webauthn.userDisplayName
                    },
                    pubKeyCredParams: [
                        { type: "public-key", alg: -7 }
                    ],
                    authenticatorSelection: {
                        userVerification: "required",
                        requireResidentKey: false
                    },
                    timeout: CONFIG.webauthn.timeout,
                    attestation: "none"
                };
                
                const credential = await navigator.credentials.create({ publicKey });
                
                if (credential && credential.rawId) {
                    AppState.credentialId = new Uint8Array(credential.rawId);
                    localStorage.setItem('webauthn_credential_id', Array.from(AppState.credentialId).join(','));
                }
                
                this.onAuthenticationSuccess();
            },
            
            // 使用已有凭证认证
            authenticateWithCredential: async function() {
                const challenge = new Uint8Array(32);
                crypto.getRandomValues(challenge);
                
                const publicKey = {
                    challenge: challenge,
                    rpId: window.location.hostname,
                    allowCredentials: [
                        {
                            type: "public-key",
                            id: AppState.credentialId,
                            transports: ["internal"]
                        }
                    ],
                    userVerification: "required",
                    timeout: CONFIG.webauthn.timeout
                };
                
                const assertion = await navigator.credentials.get({ publicKey });
                
                if (assertion) {
                    this.onAuthenticationSuccess();
                } else {
                    throw new Error("认证失败");
                }
            },
            
            // 认证成功处理
            onAuthenticationSuccess: function() {
                AppState.isAuthenticated = true;
                UI.showContent();
            },
            
            // 更新状态信息
            updateStatus: function(message) {
                DOM.authStatus.textContent = message;
            },
            
            // 显示错误信息
            showError: function(message) {
                DOM.authStatus.textContent = message;
                DOM.authStatus.style.color = '#ff6b6b';
            }
        };
        
        // UI管理器
        const UI = {
            // 显示内容区域
            showContent: function() {
                // 先隐藏认证界面
                DOM.authContainer.style.opacity = "0";
                
                setTimeout(() => {
                    // 完全隐藏认证界面
                    DOM.authContainer.style.display = "none";
                    
                    // 显示主内容区域
                    DOM.contentContainer.style.display = "block";
                    
                    // 强制重绘
                    DOM.contentContainer.offsetHeight;
                    
                    // 激活主内容区域
                    setTimeout(() => {
                        DOM.contentContainer.classList.add('active');
                        
                        // 设置body背景为黑色
                        document.body.style.backgroundColor = "#000000";
                        document.body.style.background = "#000000";
                        
                        // 设置html背景为黑色
                        document.documentElement.style.backgroundColor = "#000000";
                        document.documentElement.style.background = "#000000";
                        
                        // 启动文本轮换
                        TextRotator.init();
                    }, 50);
                }, 300);
            }
        };
        
        // 初始化应用
        function initApp() {
            // 初始化认证
            AuthManager.init();
        }
        
        // 启动应用
        document.addEventListener('DOMContentLoaded', initApp);
        
        // 防止滚动
        window.addEventListener('scroll', preventScroll, { passive: false });
        window.addEventListener('touchmove', preventScroll, { passive: false });
        
        function preventScroll(e) {
            e.preventDefault();
            window.scrollTo(0, 0);
            return false;
        }
    </script>
</body>
</html>