<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,viewport-fit=cover">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <link rel="icon" type="image/x-icon" href="favicon.ico">
    <link rel="apple-touch-icon" href="ICON.png">
    <title>MagicMist</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }

        html, body {
            width: 100%;
            height: 100%;
            overflow: hidden;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
            background-color: #000000;
            color: white;
        }

        /* 认证界面 */
        #auth-container {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: #000000;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            align-items: center;
            padding-top: env(safe-area-inset-top);
            padding-bottom: env(safe-area-inset-bottom);
            z-index: 100;
        }

        .auth-image-container {
            flex: 1;
            display: flex;
            justify-content: center;
            align-items: center;
            width: 100%;
        }

        .auth-image {
            width: 220px;
            height: 220px;
            background: var(--auth-image, url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="100" height="100" viewBox="0 0 100 100"><circle cx="50" cy="40" r="20" fill="%23fff" /><path d="M30,75 Q50,90 70,75" stroke="%23fff" stroke-width="5" fill="none" /></svg>')) center/contain no-repeat;
            position: relative;
        }

        .auth-button-container {
            width: 100%;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }

        .auth-button {
            background: #fff;
            color: #000;
            border: none;
            border-radius: 30px;
            padding: 16px 40px;
            font-size: 18px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .auth-button:active {
            transform: scale(0.95);
            opacity: 0.8;
        }

        .auth-status {
            margin-top: 15px;
            color: rgba(255, 255, 255, 0.7);
            font-size: 14px;
            min-height: 20px;
            text-align: center;
        }

        /* 主内容区域 - 简化版 */
        #content-container {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: #000000;
        }

        /* 响应式设计 */
        @media (max-width: 768px) {
            .auth-image {
                width: 180px;
                height: 180px;
            }
        }

        @media (max-width: 480px) {
            .auth-button {
                padding: 14px 32px;
                font-size: 16px;
            }
            
            .auth-image {
                width: 150px;
                height: 150px;
            }
        }
    </style>
</head>
<body>
    <!-- Face ID认证界面 -->
    <div id="auth-container">
        <div class="auth-image-container">
            <div class="auth-image"></div>
        </div>
        <div class="auth-button-container">
            <button class="auth-button" id="authButton">Face ID认证</button>
            <div class="auth-status" id="authStatus"></div>
        </div>
    </div>

    <!-- 主内容区域 - 简化版 -->
    <div id="content-container">
        <!-- 纯黑色主页面，无任何内容 -->
    </div>

    <script>
        // 应用配置
        const CONFIG = {
            // 认证界面配置
            authImage: 'ICON.png',
            
            // WebAuthn配置
            webauthn: {
                rpName: "MagicMist",
                userName: "霧@MagicMist",
                userDisplayName: "霧@MagicMist'",
                timeout: 60000
            }
        };
        
        // 应用状态管理
        const AppState = {
            isAuthenticated: false,
            credentialId: null
        };
        
        // DOM元素引用
        const DOM = {
            authContainer: document.getElementById('auth-container'),
            contentContainer: document.getElementById('content-container'),
            authButton: document.getElementById('authButton'),
            authStatus: document.getElementById('authStatus')
        };
        
        // 认证管理器
        const AuthManager = {
            // 初始化认证
            init: function() {
                // 设置认证界面图片
                document.documentElement.style.setProperty('--auth-image', `url('${CONFIG.authImage}')`);
                
                // 检查是否支持WebAuthn
                if (!window.PublicKeyCredential) {
                    this.showError("您的设备不支持生物识别功能");
                    DOM.authButton.disabled = true;
                    return;
                }
                
                // 检查是否有已保存的通行密钥
                this.checkExistingCredentials();
                
                // 添加认证按钮事件监听
                DOM.authButton.addEventListener('click', () => this.startAuthentication());
            },
            
            // 检查已有凭证
            checkExistingCredentials: function() {
                try {
                    const savedCredentialId = localStorage.getItem('webauthn_credential_id');
                    
                    if (savedCredentialId) {
                        AppState.credentialId = Uint8Array.from(savedCredentialId.split(',').map(Number));
                        DOM.authButton.textContent = "使用Face ID登录";
                    } else {
                        DOM.authButton.textContent = "注册Face ID";
                    }
                } catch (error) {
                    console.error("检查已保存凭证时出错:", error);
                    DOM.authButton.textContent = "Face ID认证";
                }
            },
            
            // 开始认证流程
            startAuthentication: async function() {
                try {
                    DOM.authButton.disabled = true;
                    this.updateStatus("准备认证中...");
                    
                    if (AppState.credentialId) {
                        this.updateStatus("请使用Face ID进行认证...");
                        await this.authenticateWithCredential();
                    } else {
                        this.updateStatus("正在注册Face ID...");
                        await this.registerNewCredential();
                    }
                } catch (error) {
                    console.error("认证失败:", error);
                    this.showError("认证失败: " + error.message);
                    DOM.authButton.disabled = false;
                }
            },
            
            // 注册新凭证
            registerNewCredential: async function() {
                const challenge = new Uint8Array(32);
                crypto.getRandomValues(challenge);
                
                const publicKey = {
                    challenge: challenge,
                    rp: { 
                        id: window.location.hostname, 
                        name: CONFIG.webauthn.rpName
                    },
                    user: {
                        id: new Uint8Array(16),
                        name: CONFIG.webauthn.userName,
                        displayName: CONFIG.webauthn.userDisplayName
                    },
                    pubKeyCredParams: [
                        { type: "public-key", alg: -7 }
                    ],
                    authenticatorSelection: {
                        userVerification: "required",
                        requireResidentKey: false
                    },
                    timeout: CONFIG.webauthn.timeout,
                    attestation: "none"
                };
                
                const credential = await navigator.credentials.create({ publicKey });
                
                if (credential && credential.rawId) {
                    AppState.credentialId = new Uint8Array(credential.rawId);
                    localStorage.setItem('webauthn_credential_id', Array.from(AppState.credentialId).join(','));
                }
                
                this.onAuthenticationSuccess();
            },
            
            // 使用已有凭证认证
            authenticateWithCredential: async function() {
                const challenge = new Uint8Array(32);
                crypto.getRandomValues(challenge);
                
                const publicKey = {
                    challenge: challenge,
                    rpId: window.location.hostname,
                    allowCredentials: [
                        {
                            type: "public-key",
                            id: AppState.credentialId,
                            transports: ["internal"]
                        }
                    ],
                    userVerification: "required",
                    timeout: CONFIG.webauthn.timeout
                };
                
                const assertion = await navigator.credentials.get({ publicKey });
                
                if (assertion) {
                    this.onAuthenticationSuccess();
                } else {
                    throw new Error("认证失败");
                }
            },
            
            // 认证成功处理
            onAuthenticationSuccess: function() {
                AppState.isAuthenticated = true;
                UI.showContent();
            },
            
            // 更新状态信息
            updateStatus: function(message) {
                DOM.authStatus.textContent = message;
            },
            
            // 显示错误信息
            showError: function(message) {
                DOM.authStatus.textContent = message;
                DOM.authStatus.style.color = '#ff6b6b';
            }
        };
        
        // UI管理器
        const UI = {
            // 显示内容区域
            showContent: function() {
                DOM.authContainer.style.display = "none";
                DOM.contentContainer.style.display = "block";
            },
            
            // 显示认证界面
            showAuth: function() {
                DOM.contentContainer.style.display = "none";
                DOM.authContainer.style.display = "flex";
            }
        };
        
        // 初始化应用
        function initApp() {
            // 初始化认证
            AuthManager.init();
            console.log('应用初始化完成');
        }
        
        // 启动应用
        document.addEventListener('DOMContentLoaded', initApp);
    </script>
</body>
</html>